#!/bin/bash
# Pre-commit hook to protect credentials from being committed
#
# This hook BLOCKS:
# - ANY changes to .env.example
# - ANY .env files being committed
#
# To bypass (not recommended): git commit --no-verify
# To disable permanently: rm .githooks/pre-commit

set -e

RED='\033[0;31m'
NC='\033[0m' # No Color

# =============================================================================
# BLOCK: Any modifications to .env.example
# =============================================================================
if git diff --cached --name-only | grep -q "^\.env\.example$"; then
    echo ""
    echo -e "${RED}=========================================="
    echo "COMMIT BLOCKED: .env.example is protected"
    echo -e "==========================================${NC}"
    echo ""
    echo ".env.example should only contain placeholder values."
    echo "It must not be modified to prevent accidental credential commits."
    echo ""
    echo "To undo your changes to .env.example:"
    echo "  git restore --staged .env.example"
    echo "  git restore .env.example"
    echo ""
    echo "If you intentionally need to update the template:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

# =============================================================================
# BLOCK: Any .env files (except .env.example)
# =============================================================================
ENV_FILES=$(git diff --cached --name-only | grep -E '^\.env$|^\.env\.[^e]|^\.env\.local|^\.env\.production|^\.env\.development' || true)

if [ -n "$ENV_FILES" ]; then
    echo ""
    echo -e "${RED}=========================================="
    echo "COMMIT BLOCKED: .env files detected"
    echo -e "==========================================${NC}"
    echo ""
    echo "These files contain secrets and must never be committed:"
    echo "$ENV_FILES"
    echo ""
    echo "To remove from staging:"
    for f in $ENV_FILES; do
        echo "  git restore --staged $f"
    done
    echo ""
    exit 1
fi

# =============================================================================
# BLOCK: Common credential file patterns
# =============================================================================
CRED_FILES=$(git diff --cached --name-only | grep -iE 'credentials|secrets|\.pem$|\.key$|service.account.*\.json$|token\.json$' || true)

if [ -n "$CRED_FILES" ]; then
    echo ""
    echo -e "${RED}=========================================="
    echo "COMMIT BLOCKED: Credential files detected"
    echo -e "==========================================${NC}"
    echo ""
    echo "These files may contain secrets:"
    echo "$CRED_FILES"
    echo ""
    echo "To remove from staging:"
    for f in $CRED_FILES; do
        echo "  git restore --staged $f"
    done
    echo ""
    exit 1
fi

exit 0
